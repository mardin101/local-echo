!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("rxjs"),require("rxjs/operators"),require("socket.io-client"),require("@angular/common"),require("@angular/common/http"),require("@angular/core")):"function"==typeof define&&define.amd?define(["exports","rxjs","rxjs/operators","socket.io-client","@angular/common","@angular/common/http","@angular/core"],n):n(e.ngxLaravelEcho={},e.Rx,e.Rx.Observable.prototype,e.io,e.ng.common,e.ng.common.http,e.ng.core)}(this,function(e,o,r,i,t,s,c){"use strict";var u=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},a=function(){function r(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,n,t){return n&&r(e.prototype,n),t&&r(e,t),e}}(),h=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},l=function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)},f=function(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n},p=function(){function n(e){u(this,n),this._defaultOptions={auth:{headers:{}},authEndpoint:"/broadcasting/auth",broadcaster:"pusher",csrfToken:null,host:null,key:null,namespace:"App.Events"},this.setOptions(e),this.connect()}return a(n,[{key:"setOptions",value:function(e){return this.options=h(this._defaultOptions,e),this.csrfToken()&&(this.options.auth.headers["X-CSRF-TOKEN"]=this.csrfToken()),e}},{key:"csrfToken",value:function(){var e=void 0;return"undefined"!=typeof window&&window.Laravel&&window.Laravel.csrfToken?window.Laravel.csrfToken:this.options.csrfToken?this.options.csrfToken:"undefined"!=typeof document&&(e=document.querySelector('meta[name="csrf-token"]'))?e.getAttribute("content"):null}}]),n}(),v=function(){function e(){u(this,e)}return a(e,[{key:"listenForWhisper",value:function(e,n){return this.listen(".client-"+e,n)}},{key:"notification",value:function(e){return this.listen(".Illuminate\\Notifications\\Events\\BroadcastNotificationCreated",e)}}]),e}(),y=function(){function n(e){u(this,n),this.setNamespace(e)}return a(n,[{key:"format",value:function(e){return"."===e.charAt(0)||"\\"===e.charAt(0)?e.substr(1):(this.namespace&&(e=this.namespace+"."+e),e.replace(/\./g,"\\"))}},{key:"setNamespace",value:function(e){this.namespace=e}}]),n}(),b=function(e){function i(e,n,t){u(this,i);var r=f(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return r.name=n,r.pusher=e,r.options=t,r.eventFormatter=new y(r.options.namespace),r.subscribe(),r}return l(i,v),a(i,[{key:"subscribe",value:function(){this.subscription=this.pusher.subscribe(this.name)}},{key:"unsubscribe",value:function(){this.pusher.unsubscribe(this.name)}},{key:"listen",value:function(e,n){return this.on(this.eventFormatter.format(e),n),this}},{key:"stopListening",value:function(e){return this.subscription.unbind(this.eventFormatter.format(e)),this}},{key:"on",value:function(e,n){return this.subscription.bind(e,n),this}}]),i}(),d=function(e){function n(){return u(this,n),f(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return l(n,b),a(n,[{key:"whisper",value:function(e,n){return this.pusher.channels.channels[this.name].trigger("client-"+e,n),this}}]),n}(),g=function(e){function n(){return u(this,n),f(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return l(n,b),a(n,[{key:"here",value:function(e){return this.on("pusher:subscription_succeeded",function(n){e(Object.keys(n.members).map(function(e){return n.members[e]}))}),this}},{key:"joining",value:function(n){return this.on("pusher:member_added",function(e){n(e.info)}),this}},{key:"leaving",value:function(n){return this.on("pusher:member_removed",function(e){n(e.info)}),this}},{key:"whisper",value:function(e,n){return this.pusher.channels.channels[this.name].trigger("client-"+e,n),this}}]),n}(),k=function(e){function i(e,n,t){u(this,i);var r=f(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return r.events={},r.name=n,r.socket=e,r.options=t,r.eventFormatter=new y(r.options.namespace),r.subscribe(),r.configureReconnector(),r}return l(i,v),a(i,[{key:"subscribe",value:function(){this.socket.emit("subscribe",{channel:this.name,auth:this.options.auth||{}})}},{key:"unsubscribe",value:function(){this.unbind(),this.socket.emit("unsubscribe",{channel:this.name,auth:this.options.auth||{}})}},{key:"listen",value:function(e,n){return this.on(this.eventFormatter.format(e),n),this}},{key:"stopListening",value:function(e){var n=this.eventFormatter.format(e);return this.socket.removeListener(n),delete this.events[n],this}},{key:"on",value:function(e,t){var r=this,n=function(e,n){r.name==e&&t(n)};this.socket.on(e,n),this.bind(e,n)}},{key:"configureReconnector",value:function(){var e=this,n=function(){e.subscribe()};this.socket.on("reconnect",n),this.bind("reconnect",n)}},{key:"bind",value:function(e,n){this.events[e]=this.events[e]||[],this.events[e].push(n)}},{key:"unbind",value:function(){var t=this;Object.keys(this.events).forEach(function(n){t.events[n].forEach(function(e){t.socket.removeListener(n,e)}),delete t.events[n]})}}]),i}(),m=function(e){function n(){return u(this,n),f(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return l(n,k),a(n,[{key:"whisper",value:function(e,n){return this.socket.emit("client event",{channel:this.name,event:"client-"+e,data:n}),this}}]),n}(),_=function(e){function n(){return u(this,n),f(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return l(n,m),a(n,[{key:"here",value:function(n){return this.on("presence:subscribed",function(e){n(e.map(function(e){return e.user_info}))}),this}},{key:"joining",value:function(n){return this.on("presence:joining",function(e){return n(e.user_info)}),this}},{key:"leaving",value:function(n){return this.on("presence:leaving",function(e){return n(e.user_info)}),this}}]),n}(),O=function(e){function n(){return u(this,n),f(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return l(n,v),a(n,[{key:"subscribe",value:function(){}},{key:"unsubscribe",value:function(){}},{key:"listen",value:function(e,n){return this}},{key:"stopListening",value:function(e){return this}},{key:"on",value:function(e,n){return this}}]),n}(),w=function(e){function n(){return u(this,n),f(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return l(n,O),a(n,[{key:"whisper",value:function(e,n){return this}}]),n}(),j=function(e){function n(){return u(this,n),f(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return l(n,O),a(n,[{key:"here",value:function(e){return this}},{key:"joining",value:function(e){return this}},{key:"leaving",value:function(e){return this}},{key:"whisper",value:function(e,n){return this}}]),n}(),x=function(e){function n(){u(this,n);var e=f(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments));return e.channels={},e}return l(n,p),a(n,[{key:"connect",value:function(){void 0!==this.options.client?this.pusher=this.options.client:this.pusher=new Pusher(this.options.key,this.options)}},{key:"listen",value:function(e,n,t){return this.channel(e).listen(n,t)}},{key:"channel",value:function(e){return this.channels[e]||(this.channels[e]=new b(this.pusher,e,this.options)),this.channels[e]}},{key:"privateChannel",value:function(e){return this.channels["private-"+e]||(this.channels["private-"+e]=new d(this.pusher,"private-"+e,this.options)),this.channels["private-"+e]}},{key:"presenceChannel",value:function(e){return this.channels["presence-"+e]||(this.channels["presence-"+e]=new g(this.pusher,"presence-"+e,this.options)),this.channels["presence-"+e]}},{key:"leave",value:function(e){var t=this;[e,"private-"+e,"presence-"+e].forEach(function(e,n){t.channels[e]&&(t.channels[e].unsubscribe(),delete t.channels[e])})}},{key:"socketId",value:function(){return this.pusher.connection.socket_id}},{key:"disconnect",value:function(){this.pusher.disconnect()}}]),n}(),C=function(e){function n(){u(this,n);var e=f(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments));return e.channels={},e}return l(n,p),a(n,[{key:"connect",value:function(){var e=this.getSocketIO();return this.socket=e(this.options.host,this.options),this.socket}},{key:"getSocketIO",value:function(){if("undefined"!=typeof io)return io;if(void 0!==this.options.client)return this.options.client;throw new Error("Socket.io client not found. Should be globally available or passed via options.client")}},{key:"listen",value:function(e,n,t){return this.channel(e).listen(n,t)}},{key:"channel",value:function(e){return this.channels[e]||(this.channels[e]=new k(this.socket,e,this.options)),this.channels[e]}},{key:"privateChannel",value:function(e){return this.channels["private-"+e]||(this.channels["private-"+e]=new m(this.socket,"private-"+e,this.options)),this.channels["private-"+e]}},{key:"presenceChannel",value:function(e){return this.channels["presence-"+e]||(this.channels["presence-"+e]=new _(this.socket,"presence-"+e,this.options)),this.channels["presence-"+e]}},{key:"leave",value:function(e){var n=this;[e,"private-"+e,"presence-"+e].forEach(function(e){n.channels[e]&&(n.channels[e].unsubscribe(),delete n.channels[e])})}},{key:"socketId",value:function(){return this.socket.id}},{key:"disconnect",value:function(){this.socket.disconnect()}}]),n}(),S=function(e){function n(){u(this,n);var e=f(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments));return e.channels={},e}return l(n,p),a(n,[{key:"connect",value:function(){}},{key:"listen",value:function(e,n,t){return new O}},{key:"channel",value:function(e){return new O}},{key:"privateChannel",value:function(e){return new w}},{key:"presenceChannel",value:function(e){return new j}},{key:"leave",value:function(e){}},{key:"socketId",value:function(){return"fake-socket-id"}},{key:"disconnect",value:function(){}}]),n}(),I=function(){function n(e){u(this,n),this.options=e,this.connect(),this.registerInterceptors()}return a(n,[{key:"channel",value:function(e){return this.connector.channel(e)}},{key:"connect",value:function(){"pusher"==this.options.broadcaster?this.connector=new x(this.options):"socket.io"==this.options.broadcaster?this.connector=new C(this.options):"null"==this.options.broadcaster&&(this.connector=new S(this.options))}},{key:"disconnect",value:function(){this.connector.disconnect()}},{key:"join",value:function(e){return this.connector.presenceChannel(e)}},{key:"leave",value:function(e){this.connector.leave(e)}},{key:"listen",value:function(e,n,t){return this.connector.listen(e,n,t)}},{key:"private",value:function(e){return this.connector.privateChannel(e)}},{key:"socketId",value:function(){return this.connector.socketId()}},{key:"registerInterceptors",value:function(){"function"==typeof Vue&&Vue.http&&this.registerVueRequestInterceptor(),"function"==typeof axios&&this.registerAxiosRequestInterceptor(),"function"==typeof jQuery&&this.registerjQueryAjaxSetup()}},{key:"registerVueRequestInterceptor",value:function(){var t=this;Vue.http.interceptors.push(function(e,n){t.socketId()&&e.headers.set("X-Socket-ID",t.socketId()),n()})}},{key:"registerAxiosRequestInterceptor",value:function(){var n=this;axios.interceptors.request.use(function(e){return n.socketId()&&(e.headers["X-Socket-Id"]=n.socketId()),e})}},{key:"registerjQueryAjaxSetup",value:function(){var n=this;void 0!==jQuery.ajax&&jQuery.ajaxSetup({beforeSend:function(e){n.socketId()&&e.setRequestHeader("X-Socket-Id",n.socketId())}})}}]),n}(),L=new c.InjectionToken("echo.config"),E=function(){function e(e){this.namespace=null,this.setNamespace(e)}return e.prototype.format=function(e){return this.namespace&&0===e.indexOf(this.namespace)?e.substr(this.namespace.length):e},e.prototype.setNamespace=function(e){return this.namespace=e,this},e}(),F=function(){function e(e,n){var v=this;this.ngZone=e,this.config=n,this.channels=[],this.notificationListeners={},this.userChannelName=null;var t=Object.assign({},n.options);switch("socket.io"===t.broadcaster&&(t=Object.assign({client:i},t)),this._echo=new I(t),this.options=this.echo.connector.options,this.typeFormatter=new E(n.notificationNamespace),t.broadcaster){case"null":this.connectionState$=o.of({type:"connected"});break;case"socket.io":this.connectionState$=new o.Observable(function(n){var e=v._echo.connector.socket,t=function(){return v.ngZone.run(function(){return n.next({type:"connect"})})},r=function(e){return v.ngZone.run(function(){return n.next({type:"connect_error",error:e})})},i=function(e){return v.ngZone.run(function(){return n.next({type:"connect_timeout",timeout:e})})},o=function(e){return v.ngZone.run(function(){return n.next({type:"error",error:e})})},s=function(e){return v.ngZone.run(function(){return n.next({type:"disconnect",reason:e})})},c=function(e){return v.ngZone.run(function(){return n.next({type:"reconnect",attemptNumber:e})})},u=function(e){return v.ngZone.run(function(){return n.next({type:"reconnect_attempt",attemptNumber:e})})},a=function(e){return v.ngZone.run(function(){return n.next({type:"reconnecting",attemptNumber:e})})},h=function(e){return v.ngZone.run(function(){return n.next({type:"reconnect_error",error:e})})},l=function(){return v.ngZone.run(function(){return n.next({type:"reconnect_failed"})})},f=function(){return v.ngZone.run(function(){return n.next({type:"ping"})})},p=function(e){return v.ngZone.run(function(){return n.next({type:"pong",latency:e})})};return e.on("connect",t),e.on("connect_error",r),e.on("connect_timeout",i),e.on("error",o),e.on("disconnect",s),e.on("reconnect",c),e.on("reconnect_attempt",u),e.on("reconnecting",a),e.on("reconnect_error",h),e.on("reconnect_failed",l),e.on("ping",f),e.on("pong",p),function(){e.off("connect",t),e.off("connect_error",r),e.off("connect_timeout",i),e.off("error",o),e.off("disconnect",s),e.off("reconnect",c),e.off("reconnect_attempt",u),e.off("reconnecting",a),e.off("reconnect_error",h),e.off("reconnect_failed",l),e.off("ping",f),e.off("pong",p)}}).pipe(r.shareReplay(1));break;case"pusher":this.connectionState$=new o.Observable(function(t){var e=v._echo.connector.pusher.connection,n=function(e){var n=e.current;return v.ngZone.run(function(){return t.next({type:n})})},r=function(e){return v.ngZone.run(function(){return t.next({type:"connecting_in",delay:e})})};return e.bind("state_change",n),e.bind("connecting_in",r),function(){e.unbind("state_change",n),e.unbind("connecting_in",r)}}).pipe(r.shareReplay(1));break;default:this.connectionState$=o.throwError(new Error("unsupported"))}this.connected$=this.connectionState$.pipe(r.map(function(){return v.connected}),r.startWith(this.connected),r.distinctUntilChanged(),r.shareReplay(1))}return Object.defineProperty(e.prototype,"connected",{get:function(){return"null"===this.options.broadcaster||("pusher"===this.options.broadcaster?"connected"===this._echo.connector.pusher.connection.state:this._echo.connector.socket.connected)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"connectionState",{get:function(){return this.connected$},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rawConnectionState",{get:function(){return this.connectionState$},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"echo",{get:function(){return this._echo},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"socketId",{get:function(){return this.echo.socketId()},enumerable:!0,configurable:!0}),e.prototype.getChannelFromArray=function(n,e){void 0===e&&(e=null);var t=this.channels.find(function(e){return null!==e&&e.name===n});if(t){if(e&&t.type!==e)throw new Error("Channel "+n+" is not a "+e+" channel");return t}return null},e.prototype.requireChannelFromArray=function(e,n){void 0===n&&(n=null);var t=this.getChannelFromArray(e,n);if(t)return t;if(n)throw new Error(""+n[0].toUpperCase()+n.substr(1)+" channel "+e+" does not exist");throw new Error("Channel "+e+" does not exist")},e.prototype.publicChannel=function(e){var n=this.getChannelFromArray(e,"public");if(n)return n.channel;var t=this.echo.channel(e);return n={name:e,channel:t,type:"public",listeners:{}},this.channels.push(n),t},e.prototype.presenceChannel=function(e){var n=this,r=this.getChannelFromArray(e,"presence");if(r)return r.channel;var t=this.echo.join(e);return r={name:e,channel:t,type:"presence",listeners:{},users:null},this.channels.push(r),t.here(function(e){n.ngZone.run(function(){r&&(r.users=e,r.listeners._users_&&r.listeners._users_.next(JSON.parse(JSON.stringify(e))))})}),t.joining(function(e){n.ngZone.run(function(){r&&(r.users=r.users||[],r.users.push(e),r.listeners._joining_&&r.listeners._joining_.next(JSON.parse(JSON.stringify(e))))})}),t.leaving(function(t){n.ngZone.run(function(){if(r){r.users=r.users||[];var e=r.users.find(function(e){return e===t});if(e){var n=r.users.indexOf(e);-1!==n&&r.users.splice(n,1)}r.listeners._leaving_&&r.listeners._leaving_.next(JSON.parse(JSON.stringify(t)))}})}),t},e.prototype.privateChannel=function(e){var n=this.getChannelFromArray(e,"private");if(n)return n.channel;var t=this.echo.private(e);return n={name:e,channel:t,type:"private",listeners:{}},this.channels.push(n),t},e.prototype.login=function(e,n){var t=this,r=this.config.userModel.replace("\\",".")+"."+n;if(this.userChannelName&&this.userChannelName!==r&&this.logout(),this.options.auth=this.options.auth||{},this.options.auth.headers=Object.assign({},e),"pusher"===this.options.broadcaster){var i=this._echo.connector;i.pusher.config.auth!==this.options.auth&&(i.pusher.config.auth=this.options.auth)}return this.userChannelName!==r&&(this.userChannelName=r,this.privateChannel(r).notification(function(e){var n=t.typeFormatter.format(e.type);t.notificationListeners[n]&&t.ngZone.run(function(){return t.notificationListeners[n].next(e)}),t.notificationListeners["*"]&&t.ngZone.run(function(){return t.notificationListeners["*"].next(e)})})),this},e.prototype.logout=function(){var n=this;return this.channels.filter(function(e){return null!==e&&"public"!==e.type}).forEach(function(e){return n.leave(null!==e?e.name:"")}),this.options.auth=this.options.auth||{},this.options.auth.headers={},this},e.prototype.join=function(e,n){switch(n){case"public":this.publicChannel(e);break;case"presence":this.presenceChannel(e);break;case"private":this.privateChannel(e)}return this},e.prototype.leave=function(e){var n=this.getChannelFromArray(e);if(n){this.echo.leave(e),Object.keys(n.listeners).forEach(function(e){return n.listeners[e].complete()}),n.notificationListeners&&Object.keys(n.notificationListeners).forEach(function(e){return n.notificationListeners&&n.notificationListeners[e].complete()});var t=this.channels.indexOf(n);-1!==t&&this.channels.splice(t,1)}return this},e.prototype.listen=function(e,n){var t=this,r=this.requireChannelFromArray(e);if(!r.listeners[n]){var i=new o.Subject;r.channel.listen(n,function(e){return t.ngZone.run(function(){return i.next(e)})}),r.listeners[n]=i}return r.listeners[n].asObservable()},e.prototype.listenForWhisper=function(e,n){var t=this,r=this.requireChannelFromArray(e);if("public"===r.type)return o.throwError(new Error("Whisper is not available on public channels"));if(!r.listeners["_whisper_"+n+"_"]){var i=new o.Subject;r.channel.listenForWhisper(n,function(e){return t.ngZone.run(function(){return i.next(e)})}),r.listeners["_whisper_"+n+"_"]=i}return r.listeners["_whisper_"+n+"_"].asObservable()},e.prototype.notification=function(e,n){var t=this;if(e=this.typeFormatter.format(e),n&&n!==this.userChannelName){var r=this.requireChannelFromArray(n);return r.notificationListeners||(r.notificationListeners={},r.channel.notification(function(e){var n=t.typeFormatter.format(e.type);r.notificationListeners&&(r.notificationListeners[n]&&t.ngZone.run(function(){return r.notificationListeners&&r.notificationListeners[n].next(e)}),r.notificationListeners["*"]&&t.ngZone.run(function(){return r.notificationListeners&&r.notificationListeners["*"].next(e)}))})),r.notificationListeners[e]||(r.notificationListeners[e]=new o.Subject),r.notificationListeners[e].asObservable()}return this.notificationListeners[e]||(this.notificationListeners[e]=new o.Subject),this.notificationListeners[e].asObservable()},e.prototype.joining=function(e){var n=this.requireChannelFromArray(e,"presence");return n.listeners._joining_||(n.listeners._joining_=new o.Subject),n.listeners._joining_.asObservable()},e.prototype.leaving=function(e){var n=this.requireChannelFromArray(e,"presence");return n.listeners._leaving_||(n.listeners._leaving_=new o.Subject),n.listeners._leaving_.asObservable()},e.prototype.users=function(e){var n=this.requireChannelFromArray(e,"presence");return n.listeners._users_||(n.listeners._users_=new o.ReplaySubject(1)),n.listeners._users_.asObservable()},e.prototype.whisper=function(e,n,t){var r=this.requireChannelFromArray(e);if("public"===r.type)throw new Error("Whisper is not available on public channels");return r.channel.whisper(n,t),this},e.decorators=[{type:c.Injectable}],e.ctorParameters=function(){return[{type:c.NgZone},{type:void 0,decorators:[{type:c.Inject,args:[L]}]}]},e}(),N=function(){function e(e){this.echoService=e}return e.prototype.intercept=function(e,n){var t=this.echoService.socketId;return this.echoService.connected&&t&&(e=e.clone({headers:e.headers.append("X-Socket-ID",t)})),n.handle(e)},e.decorators=[{type:c.Injectable}],e.ctorParameters=function(){return[{type:F}]},e}(),n=function(){function n(){}return n.forRoot=function(e){return{ngModule:n,providers:[F,{provide:s.HTTP_INTERCEPTORS,useClass:N,multi:!0},{provide:L,useValue:e}]}},n.decorators=[{type:c.NgModule,args:[{imports:[t.CommonModule]}]}],n}();e.EchoService=F,e.EchoInterceptor=N,e.NgxLaravelEchoModule=n,e.ECHO_CONFIG=L,Object.defineProperty(e,"__esModule",{value:!0})});
